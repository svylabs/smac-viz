(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=i(t);fetch(t.href,o)}})();class O{constructor(){this.config=null,this.currentStateId=null,this.previousStateId=null,this.context={},this.history=[],this.listeners=[],this.lastEventId=null}load(e){if(console.log("VisualizerEngine: Loading config",e==null?void 0:e.id),!e||!e.states){console.error("VisualizerEngine: Invalid config provided");return}this.config=e,this.context=JSON.parse(JSON.stringify(e.context||{})),this.currentStateId=e.initialState,this.previousStateId=null,this.lastEventId=null,this.history=[],this.recordHistory("Initial State"),this.notify(),console.log("VisualizerEngine: Load complete. Current state:",this.currentStateId)}subscribe(e){this.listeners.push(e)}notify(){this.listeners.forEach(e=>e(this.getState()))}send(e,i={}){const t=this.config.states[this.currentStateId].on[e];if(!t)return console.error(`No transition found for event ${e} in state ${this.currentStateId}`),!1;if(t.action)try{const o=new Function("context","input",`
                    ${t.action};
                    return context;
                `);this.context=o(JSON.parse(JSON.stringify(this.context)),i)}catch(o){return console.error(`Action error for ${e}:`,o),{error:o.message}}return this.previousStateId=this.currentStateId,this.currentStateId=t.to,this.lastEventId=e,this.recordHistory(e,i),this.notify(),!0}recordHistory(e,i={}){this.history.push({timestamp:new Date().toLocaleTimeString(),state:this.currentStateId,event:e,context:JSON.parse(JSON.stringify(this.context)),input:JSON.parse(JSON.stringify(i))})}generateMermaid(){if(!this.config)return"";let e=`flowchart LR
`;e+=`    classDef current fill:#6366f1,stroke:#fff,stroke-width:2px,color:#fff
`,e+=`    classDef previous fill:#10b981,stroke:#fff,stroke-width:1px,color:#fff

`,Object.entries(this.config.states).forEach(([t,o])=>{const r=o.label||t;e+=`    ${t}("${r}")
`,t===this.currentStateId?e+=`    class ${t} current
`:t===this.previousStateId&&(e+=`    class ${t} previous
`)}),e+=`
`;let i=0,s=-1;return Object.entries(this.config.states).forEach(([t,o])=>{o.on&&Object.entries(o.on).forEach(([r,a])=>{const c=a.label||r;e+=`    ${t} -->|"${c}"| ${a.to}
`,t===this.previousStateId&&r===this.lastEventId&&(s=i),i++})}),s!==-1&&(e+=`    linkStyle ${s} stroke:#6366f1,stroke-width:4px,color:#6366f1
`),e}getState(){const e=this.config?this.config.states[this.currentStateId]:null;return!e&&this.config&&console.warn(`VisualizerEngine: State ${this.currentStateId} not found in config`),{id:this.currentStateId,data:e,context:this.context,availableEvents:e?e.on:{},mermaid:this.generateMermaid(),history:this.history}}undo(){if(this.history.length<=1)return;this.history.pop();const e=this.history[this.history.length-1];this.currentStateId=e.state,this.context=JSON.parse(JSON.stringify(e.context)),this.lastEventId=e.event==="Initial State"?null:e.event,this.previousStateId=this.history.length>1?this.history[this.history.length-2].state:null,console.log("VisualizerEngine: Undo to",this.currentStateId),this.notify()}async replay(e,i=500){console.log("VisualizerEngine: Starting replay of",e.length,"events"),this.reset();for(const s of e)await new Promise(t=>setTimeout(t,i)),this.send(s.event,s.input);console.log("VisualizerEngine: Replay complete")}reset(){this.config&&(console.log("VisualizerEngine: Resetting"),this.load(this.config))}}const l=new O;window.engine=l;let f;const N="default-example.json";mermaid.initialize({startOnLoad:!1,theme:"dark",securityLevel:"loose",state:{useMaxWidth:!1}});require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs"}});require(["vs/editor/editor.main"],function(){f=monaco.editor.create(document.getElementById("editor-container"),{value:"",language:"json",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},fontSize:13,lineNumbers:"on",scrollBeyondLastLine:!1,wordWrap:"on",wrappingStrategy:"advanced",roundedSelection:!1,padding:{top:10}}),I()});const p=document.getElementById("resizer"),z=document.getElementById("sidebar");let h=!1;p.addEventListener("mousedown",n=>{window.innerWidth<=1024||(h=!0,p.classList.add("active"),document.body.style.cursor="col-resize",document.body.style.userSelect="none")});document.addEventListener("mousemove",n=>{if(!h)return;const e=Math.max(250,Math.min(window.innerWidth-100,n.clientX));document.documentElement.style.setProperty("--editor-width",`${e}px`),f&&f.layout()});document.addEventListener("mouseup",()=>{h&&(h=!1,p.classList.remove("active"),document.body.style.cursor="default",document.body.style.userSelect="auto")});window.toggleSidebar=function(){z.classList.toggle("active")};window.switchMainTab=function(n){document.querySelectorAll(".tab-pane").forEach(o=>o.classList.remove("active"));const i=document.querySelectorAll(".sidebar-tabs .tab-btn");i.forEach(o=>o.classList.remove("active")),document.getElementById(`tab-${n}`).classList.add("active");const t=Array.from(i).find(o=>o.textContent.toLowerCase().includes(n));t&&t.classList.add("active"),n==="code"&&f&&setTimeout(()=>f.layout(),10)};async function I(){try{const n=await fetch(N);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const e=await n.json();f.setValue(JSON.stringify(e,null,2)),w()}catch(n){$("Failed to load default config: "+n.message)}}function w(){try{const n=f.getValue(),e=JSON.parse(n);document.getElementById("error-overlay").style.display="none",l.listeners.length===0&&l.subscribe(j),l.load(e)}catch(n){$("Invalid JSON: "+n.message)}}function $(n){document.getElementById("error-overlay").style.display="flex",document.getElementById("error-message").textContent=n}document.getElementById("btn-apply-json").onclick=w;document.getElementById("btn-reset-json").onclick=I;document.getElementById("btn-hide-error").onclick=()=>{document.getElementById("error-overlay").style.display="none"};function x(){var n;return`visualizer_view_${(n=l.config)==null?void 0:n.id}`}let b=!0;const T=document.getElementById("mermaid-root");["mousedown","touchstart","wheel"].forEach(n=>{T.addEventListener(n,()=>{b=!1},{passive:!0})});function S(){if(!u||!l.config||b)return;const n={pan:u.getPan(),zoom:u.getZoom(),scenarioId:l.config.id};localStorage.setItem(x(),JSON.stringify(n))}function J(){var i;const n=(i=l.config)==null?void 0:i.id;if(!n)return null;const e=localStorage.getItem(x());if(!e)return null;try{const s=JSON.parse(e);return s.scenarioId===n?s:null}catch{return null}}let u;async function j(n){var s,t,o;(s=l.config)==null||s.id;const e=J();u&&(u.destroy(),u=null),document.getElementById("current-state-label").textContent=((t=n.data)==null?void 0:t.label)||n.id,document.getElementById("current-state-desc").textContent=((o=n.data)==null?void 0:o.description)||"",document.getElementById("state-json").textContent=JSON.stringify(n.context,null,2);const i=document.getElementById("history-log");i&&(i.innerHTML=n.history.slice().reverse().map(r=>`
                    <div class="history-item">
                        <span class="time">${r.timestamp}</span>
                        <span class="event">${r.event}</span>
                        <div style="font-size: 0.7rem; opacity: 0.6;">To: ${r.state}</div>
                    </div>
                `).join(""));try{const r=document.getElementById("mermaid-root");r.removeAttribute("data-processed"),r.innerHTML=n.mermaid,await mermaid.run({nodes:[r]});const a=r.querySelector("svg");a&&(b=!0,u=svgPanZoom(a,{zoomEnabled:!0,controlIconsEnabled:!1,fit:!e,center:!e,minZoom:.05,maxZoom:20,onZoom:()=>S(),onPan:()=>S()}),window.panZoom=u,e&&(u.zoom(e.zoom),u.pan(e.pan)))}catch(r){console.error("Mermaid/PanZoom Error:",r)}C(n)}function C(n){const e=document.getElementById("controls-root");e.innerHTML="";const i=Object.entries(n.availableEvents||{});if(i.length===0){e.innerHTML='<p style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">No actions available in this state.</p>';return}i.forEach(([s,t])=>{const o=document.createElement("div");o.className="input-group";const r=document.createElement("button");r.className="btn-action",r.innerHTML=`
                    <span class="label">${t.label||s}</span>
                    <span class="target">→ ${n.id!==t.to?t.to:"Self"}</span>
                `,t.inputs&&t.inputs.forEach(a=>{const c=document.createElement("div");c.className="input-field",a.type==="table"?c.innerHTML=`
                                <label>${a.label||a.name}</label>
                                <div class="table-input-container">
                                    <table class="input-table" id="table-${s}-${a.name}">
                                        <thead>
                                            <tr>
                                                ${a.columns.map(d=>`<th>${d.label||d.name}</th>`).join("")}
                                                <th style="width: 30px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Rows injected here -->
                                        </tbody>
                                    </table>
                                    <button class="btn-table-add" onclick="addTableRow('${s}', '${a.name}', ${JSON.stringify(a.columns).replace(/"/g,"&quot;")})">
                                        + Add Row
                                    </button>
                                </div>
                            `:c.innerHTML=`
                                <label>${a.label||a.name}</label>
                                <input type="${a.type||"text"}" 
                                       id="input-${s}-${a.name}" 
                                       value="${a.default||""}">
                            `,o.appendChild(c)}),r.onclick=()=>{const a={};t.inputs&&t.inputs.forEach(d=>{if(d.type==="table"){const L=document.getElementById(`table-${s}-${d.name}`).querySelectorAll(".table-row");a[d.name]=Array.from(L).map(B=>{const v={};return d.columns.forEach(g=>{const E=B.querySelector(`[data-col="${g.name}"]`);v[g.name]=g.type==="number"?parseFloat(E.value):E.value}),v})}else{const y=document.getElementById(`input-${s}-${d.name}`).value;a[d.name]=d.type==="number"?parseFloat(y):y}});const c=l.send(s,a);c&&c.error&&alert("Action Error: "+c.error)},o.appendChild(r),e.appendChild(o)})}window.addTableRow=function(n,e,i){const s=document.querySelector(`#table-${n}-${e} tbody`),t=document.createElement("tr");t.className="table-row";let o=i.map(r=>`
                <td>
                    <input type="${r.type==="number"?"number":"text"}" 
                           data-col="${r.name}" 
                           value="${r.default||""}">
                </td>
            `).join("");o+=`<td><button class="btn-table-del" onclick="this.closest('tr').remove()">✕</button></td>`,t.innerHTML=o,s.appendChild(t)};let m=[];window.exitReplay=function(){m=[],document.getElementById("replay-controls").style.display="none",document.getElementById("controls-root").style.display="block"};document.getElementById("btn-replay").onclick=()=>{const n=l.history;n.length<=1||(m=n.slice(1).map(e=>({event:e.event,input:e.input})),l.reset(),document.getElementById("replay-controls").style.display="block",document.getElementById("controls-root").style.display="none",document.getElementById("replay-remaining").textContent=`${m.length} steps remaining`)};document.getElementById("btn-replay-next").onclick=()=>{if(m.length===0)return;const n=m.shift();l.send(n.event,n.input),m.length===0?setTimeout(()=>{alert("Replay Finished!"),exitReplay()},100):document.getElementById("replay-remaining").textContent=`${m.length} steps remaining`};
