var N=Object.defineProperty;var C=(e,t,n)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var I=(e,t,n)=>C(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();class k{constructor(){this.config=null,this.currentStateId=null,this.previousStateId=null,this.context={},this.history=[],this.listeners=[],this.lastEventId=null}load(t){if(console.log("VisualizerEngine: Loading config",t==null?void 0:t.id),!t||!t.states){console.error("VisualizerEngine: Invalid config provided");return}this.config=t,this.context=JSON.parse(JSON.stringify(t.context||{})),this.currentStateId=t.initialState,this.previousStateId=null,this.lastEventId=null,this.history=[],this.recordHistory("Initial State"),this.notify(),console.log("VisualizerEngine: Load complete. Current state:",this.currentStateId)}subscribe(t){this.listeners.push(t)}notify(){this.listeners.forEach(t=>t(this.getState()))}send(t,n={}){const o=this.config.states[this.currentStateId].on[t];if(!o)return console.error(`No transition found for event ${t} in state ${this.currentStateId}`),!1;if(o.action)try{const i=new Function("context","input",`
                    ${o.action};
                    return context;
                `);this.context=i(JSON.parse(JSON.stringify(this.context)),n)}catch(i){return console.error(`Action error for ${t}:`,i),{error:i.message}}return this.previousStateId=this.currentStateId,this.currentStateId=o.to,this.lastEventId=t,this.recordHistory(t,n),this.notify(),!0}recordHistory(t,n={}){this.history.push({timestamp:new Date().toLocaleTimeString(),state:this.currentStateId,event:t,context:JSON.parse(JSON.stringify(this.context)),input:JSON.parse(JSON.stringify(n))})}generateMermaid(){if(!this.config)return"";let t=`flowchart LR
`;t+=`    classDef current fill:#6366f1,stroke:#fff,stroke-width:2px,color:#fff
`,t+=`    classDef previous fill:#10b981,stroke:#fff,stroke-width:1px,color:#fff

`,Object.entries(this.config.states).forEach(([o,i])=>{const a=i.label||o;t+=`    ${o}("${a}")
`,o===this.currentStateId?t+=`    class ${o} current
`:o===this.previousStateId&&(t+=`    class ${o} previous
`)}),t+=`
`;let n=0,s=-1;return Object.entries(this.config.states).forEach(([o,i])=>{i.on&&Object.entries(i.on).forEach(([a,l])=>{const c=l.label||a;t+=`    ${o} -->|"${c}"| ${l.to}
`,o===this.previousStateId&&a===this.lastEventId&&(s=n),n++})}),s!==-1&&(t+=`    linkStyle ${s} stroke:#6366f1,stroke-width:4px,color:#6366f1
`),t}getState(){const t=this.config?this.config.states[this.currentStateId]:null;return!t&&this.config&&console.warn(`VisualizerEngine: State ${this.currentStateId} not found in config`),{id:this.currentStateId,data:t,context:this.context,availableEvents:t?t.on:{},mermaid:this.generateMermaid(),history:this.history}}undo(){if(this.history.length<=1)return;this.history.pop();const t=this.history[this.history.length-1];this.currentStateId=t.state,this.context=JSON.parse(JSON.stringify(t.context)),this.lastEventId=t.event==="Initial State"?null:t.event,this.previousStateId=this.history.length>1?this.history[this.history.length-2].state:null,console.log("VisualizerEngine: Undo to",this.currentStateId),this.notify()}async replay(t,n=500){console.log("VisualizerEngine: Starting replay of",t.length,"events"),this.reset();for(const s of t)await new Promise(o=>setTimeout(o,n)),this.send(s.event,s.input);console.log("VisualizerEngine: Replay complete")}reset(){this.config&&(console.log("VisualizerEngine: Resetting"),this.load(this.config))}}class y{static getTests(){const t=localStorage.getItem(this.STORAGE_KEY);try{return t?JSON.parse(t):[]}catch(n){return console.error("Failed to parse tests from localStorage",n),[]}}static saveTest(t){const n=this.getTests(),s={id:crypto.randomUUID(),name:t.name||`Simulation ${new Date().toLocaleString()}`,createdAt:new Date().toISOString(),configId:t.configId,initialContext:t.initialContext,transitions:t.transitions};return n.push(s),this.persist(n),s}static updateTest(t,n){const s=this.getTests(),o=s.findIndex(i=>i.id===t);return o!==-1?(s[o]={...s[o],...n},this.persist(s),!0):!1}static deleteTest(t){let n=this.getTests();n=n.filter(s=>s.id!==t),this.persist(n)}static persist(t){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}}I(y,"STORAGE_KEY","smac_tests");const r=new k;window.engine=r;let f;const J="default-example.json";mermaid.initialize({startOnLoad:!1,theme:"dark",securityLevel:"loose",state:{useMaxWidth:!1}});require.config({paths:{vs:"https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs"}});require(["vs/editor/editor.main"],function(){f=monaco.editor.create(document.getElementById("editor-container"),{value:"",language:"json",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},fontSize:13,lineNumbers:"on",scrollBeyondLastLine:!1,wordWrap:"on",wrappingStrategy:"advanced",roundedSelection:!1,padding:{top:10}}),$()});const b=document.getElementById("resizer"),R=document.getElementById("sidebar");let h=!1;b.addEventListener("mousedown",e=>{window.innerWidth<=1024||(h=!0,b.classList.add("active"),document.body.style.cursor="col-resize",document.body.style.userSelect="none")});document.addEventListener("mousemove",e=>{if(!h)return;const t=Math.max(250,Math.min(window.innerWidth-100,e.clientX));document.documentElement.style.setProperty("--editor-width",`${t}px`),f&&f.layout()});document.addEventListener("mouseup",()=>{h&&(h=!1,b.classList.remove("active"),document.body.style.cursor="default",document.body.style.userSelect="auto")});window.toggleSidebar=function(){R.classList.toggle("active")};window.switchMainTab=function(e){document.querySelectorAll(".tab-pane").forEach(i=>i.classList.remove("active"));const n=document.querySelectorAll(".sidebar-tabs .tab-btn");n.forEach(i=>i.classList.remove("active")),document.getElementById(`tab-${e}`).classList.add("active");const o=Array.from(n).find(i=>i.textContent.toLowerCase().includes(e));o&&o.classList.add("active"),e==="code"&&f&&setTimeout(()=>f.layout(),10),e==="test"&&renderTests()};async function $(){try{const t=new URLSearchParams(window.location.search).get("code");if(t)try{const o=decodeURIComponent(escape(atob(t))),i=JSON.parse(o);f.setValue(JSON.stringify(i,null,2)),v();return}catch(o){console.error("Failed to decode code from URL:",o)}const n=await fetch(J);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const s=await n.json();f.setValue(JSON.stringify(s,null,2)),v()}catch(e){T("Failed to load configuration: "+e.message)}}function v(){try{const e=f.getValue(),t=JSON.parse(e);document.getElementById("error-overlay").style.display="none",r.listeners.length===0&&r.subscribe(M),r.load(t)}catch(e){T("Invalid JSON: "+e.message)}}function T(e){document.getElementById("error-overlay").style.display="flex",document.getElementById("error-message").textContent=e}document.getElementById("btn-apply-json").onclick=v;document.getElementById("btn-reset-json").onclick=$;document.getElementById("btn-share-json").onclick=async()=>{try{const e=f.getValue(),t=btoa(unescape(encodeURIComponent(e))),n=new URL(window.location.href);n.searchParams.set("code",t),await navigator.clipboard.writeText(n.toString());const s=document.getElementById("btn-share-json"),o=s.textContent;s.textContent="Copied!",s.style.background="#0ea5e9",setTimeout(()=>{s.textContent=o,s.style.background="var(--brand)"},2e3)}catch(e){alert("Failed to copy URL: "+e.message)}};document.getElementById("btn-save-test").onclick=()=>{if(r.history.length<=1){alert("Simulation history is empty. Perform some actions first!");return}const e={configId:r.config.id,initialContext:r.config.context||{},transitions:r.history.slice(1).map(n=>({event:n.event,input:n.input}))},t=y.saveTest(e);alert(`Test "${t.name}" saved!`),renderTests()};document.getElementById("btn-hide-error").onclick=()=>{document.getElementById("error-overlay").style.display="none"};function L(){var e;return`visualizer_view_${(e=r.config)==null?void 0:e.id}`}let S=!0;const z=document.getElementById("mermaid-root");["mousedown","touchstart","wheel"].forEach(e=>{z.addEventListener(e,()=>{S=!1},{passive:!0})});function x(){if(!u||!r.config||S)return;const e={pan:u.getPan(),zoom:u.getZoom(),scenarioId:r.config.id};localStorage.setItem(L(),JSON.stringify(e))}function j(){var n;const e=(n=r.config)==null?void 0:n.id;if(!e)return null;const t=localStorage.getItem(L());if(!t)return null;try{const s=JSON.parse(t);return s.scenarioId===e?s:null}catch{return null}}let u;async function M(e){var n,s,o;(n=r.config)==null||n.id;const t=j();u&&(u.destroy(),u=null),document.getElementById("current-state-label").textContent=((s=e.data)==null?void 0:s.label)||e.id,document.getElementById("current-state-desc").textContent=((o=e.data)==null?void 0:o.description)||"",document.getElementById("state-json").textContent=JSON.stringify(e.context,null,2);try{const i=document.getElementById("mermaid-root");i.removeAttribute("data-processed"),i.innerHTML=e.mermaid,await mermaid.run({nodes:[i]});const a=i.querySelector("svg");a&&(S=!0,u=svgPanZoom(a,{zoomEnabled:!0,controlIconsEnabled:!1,fit:!t,center:!t,minZoom:.05,maxZoom:20,onZoom:()=>x(),onPan:()=>x()}),window.panZoom=u,t&&(u.zoom(t.zoom),u.pan(t.pan)))}catch(i){console.error("Mermaid/PanZoom Error:",i)}A(e)}function A(e){const t=document.getElementById("controls-root");t.innerHTML="";const n=Object.entries(e.availableEvents||{});if(n.length===0){t.innerHTML='<p style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">No actions available in this state.</p>';return}n.forEach(([s,o])=>{const i=document.createElement("div");i.className="input-group";const a=document.createElement("button");a.className="btn-action",a.innerHTML=`
                    <span class="label">${o.label||s}</span>
                    <span class="target">→ ${e.id!==o.to?o.to:"Self"}</span>
                `,o.inputs&&o.inputs.forEach(l=>{const c=document.createElement("div");c.className="input-field",l.type==="table"?c.innerHTML=`
                                <label>${l.label||l.name}</label>
                                <div class="table-input-container">
                                    <table class="input-table" id="table-${s}-${l.name}">
                                        <thead>
                                            <tr>
                                                ${l.columns.map(d=>`<th>${d.label||d.name}</th>`).join("")}
                                                <th style="width: 30px;"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Rows injected here -->
                                        </tbody>
                                    </table>
                                    <button class="btn-table-add" onclick="addTableRow('${s}', '${l.name}', ${JSON.stringify(l.columns).replace(/"/g,"&quot;")})">
                                        + Add Row
                                    </button>
                                </div>
                            `:c.innerHTML=`
                                <label>${l.label||l.name}</label>
                                <input type="${l.type||"text"}" 
                                       id="input-${s}-${l.name}" 
                                       value="${l.default||""}">
                            `,i.appendChild(c)}),a.onclick=()=>{const l={};o.inputs&&o.inputs.forEach(d=>{if(d.type==="table"){const O=document.getElementById(`table-${s}-${d.name}`).querySelectorAll(".table-row");l[d.name]=Array.from(O).map(B=>{const E={};return d.columns.forEach(p=>{const w=B.querySelector(`[data-col="${p.name}"]`);E[p.name]=p.type==="number"?parseFloat(w.value):w.value}),E})}else{const g=document.getElementById(`input-${s}-${d.name}`).value;l[d.name]=d.type==="number"?parseFloat(g):g}});const c=r.send(s,l);c&&c.error&&alert("Action Error: "+c.error)},i.appendChild(a),t.appendChild(i)})}window.addTableRow=function(e,t,n){const s=document.querySelector(`#table-${e}-${t} tbody`),o=document.createElement("tr");o.className="table-row";let i=n.map(a=>`
                <td>
                    <input type="${a.type==="number"?"number":"text"}" 
                           data-col="${a.name}" 
                           value="${a.default||""}">
                </td>
            `).join("");i+=`<td><button class="btn-table-del" onclick="this.closest('tr').remove()">✕</button></td>`,o.innerHTML=i,s.appendChild(o)};let m=[];window.exitReplay=function(){m=[],document.getElementById("replay-controls").style.display="none",document.getElementById("controls-root").style.display="block"};document.getElementById("btn-replay").onclick=()=>{const e=r.history;e.length<=1||(m=e.slice(1).map(t=>({event:t.event,input:t.input})),r.reset(),document.getElementById("replay-controls").style.display="block",document.getElementById("controls-root").style.display="none",document.getElementById("replay-remaining").textContent=`${m.length} steps remaining`)};document.getElementById("btn-replay-next").onclick=()=>{if(m.length===0)return;const e=m.shift();r.send(e.event,e.input),m.length===0?setTimeout(()=>{alert("Replay Finished!"),exitReplay()},100):document.getElementById("replay-remaining").textContent=`${m.length} steps remaining`};window.renderTests=function(){const e=document.getElementById("test-list"),t=y.getTests();if(t.length===0){e.innerHTML='<div class="empty-state">No saved tests yet. Save a simulation from the Simulator tab.</div>';return}e.innerHTML=t.map(n=>`
                <div class="test-item" id="test-${n.id}">
                    <div class="test-header">
                        <div class="test-name-container">
                            <input type="text" class="test-name-input" value="${n.name}" 
                                   onblur="updateTestName('${n.id}', this.value)"
                                   onkeydown="if(event.key==='Enter') this.blur()">
                            <div class="test-date">Created ${new Date(n.createdAt).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="test-meta">
                        <div style="font-size: 0.75rem; color: var(--text-muted);">
                            ${n.transitions.length} steps • ${n.configId}
                        </div>
                        <div class="test-actions">
                            <button class="btn-test-run" onclick="runTest('${n.id}')">Simulate</button>
                            <button class="btn-test-delete" onclick="deleteTest('${n.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join("")};window.updateTestName=function(e,t){y.updateTest(e,{name:t})};window.deleteTest=function(e){confirm("Are you sure you want to delete this test?")&&(y.deleteTest(e),renderTests())};window.runTest=function(e){const n=y.getTests().find(s=>s.id===e);n&&(r.config.id!==n.configId&&!confirm(`Warning: This test was created for config "${n.configId}", but current config is "${r.config.id}". Run anyway?`)||(switchMainTab("sim"),m=[...n.transitions],r.reset(),n.initialContext&&(r.context=JSON.parse(JSON.stringify(n.initialContext)),r.notify()),document.getElementById("replay-controls").style.display="block",document.getElementById("controls-root").style.display="none",document.getElementById("replay-remaining").textContent=`${m.length} steps remaining`))};
